// ================================================
// COMPLETE WHOLESALE STORAGE SYSTEM
// File: wholesale-storage.js
// Just add: <script src="wholesale-storage.js"></script>
// ================================================

(function() {
    'use strict';

    console.log('ðŸ›’ Wholesale Storage System Loading...');

    // ==================== MAIN STORAGE CLASS ====================
    class WholesaleStorage {
        constructor() {
            // Auto-detect endpoints from your dashboard
            this.endpoints = this.detectEndpoints();
            
            // Storage queues
            this.syncQueue = [];
            this.isOnline = navigator.onLine;
            this.authToken = this.getAuthToken();
            
            // Initialize
            this.init();
        }

        detectEndpoints() {
            // Based on your dashboard, these are likely your endpoints
            return {
                products: '/api/products',
                orders: '/api/orders', 
                customers: '/api/customers',
                users: '/api/users',
                categories: '/api/categories',
                inventory: '/api/inventory',
                coupons: '/api/coupons',
                expenses: '/api/expenses'
            };
        }

        getAuthToken() {
            // Check common token locations in wholesale apps
            return localStorage.getItem('token') ||
                   localStorage.getItem('authToken') ||
                   localStorage.getItem('access_token') ||
                   document.cookie.match(/token=([^;]+)/)?.[1] ||
                   '';
        }

        init() {
            console.log('âš™ï¸ Initializing storage for wholesale dashboard...');
            
            // Setup event listeners
            window.addEventListener('online', () => this.handleOnline());
            window.addEventListener('offline', () => this.handleOffline());
            
            // Load existing queue
            this.loadQueue();
            
            // Start auto-sync
            setInterval(() => this.syncQueueToServer(), 30000);
            
            // Add UI components
            this.addStorageUI();
            
            // Hook into your existing app
            this.integrateWithDashboard();
            
            console.log('âœ… Wholesale Storage Ready!');
        }

        // ==================== CORE STORAGE METHODS ====================
        async saveProduct(productData) {
            return await this.saveItem('products', productData);
        }

        async saveOrder(orderData) {
            return await this.saveItem('orders', orderData);
        }

        async saveCustomer(customerData) {
            return await this.saveItem('customers', customerData);
        }

        async saveItem(type, data) {
            console.log(`ðŸ’¾ Saving ${type}:`, data);
            
            const localId = `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const itemData = {
                ...data,
                _id: localId,
                _type: type,
                _createdAt: new Date().toISOString(),
                _synced: false,
                _local: true
            };
            
            // 1. Save locally immediately
            this.saveToLocalStorage(type, itemData);
            
            // 2. Try to save to server if online
            if (this.isOnline) {
                try {
                    const serverResult = await this.saveToServer(type, data);
                    
                    // Update local copy with server data
                    this.updateLocalItem(type, localId, {
                        ...serverResult,
                        _synced: true,
                        _local: false,
                        _serverId: serverResult.id || serverResult._id
                    });
                    
                    this.showNotification(`${type} saved to server!`, 'success');
                    return serverResult;
                    
                } catch (error) {
                    console.log(`Server save failed, queuing for sync:`, error);
                    this.queueForSync(type, 'create', itemData);
                    return itemData;
                }
            } else {
                // Queue for later sync
                this.queueForSync(type, 'create', itemData);
                this.showNotification('Saved locally (offline)', 'warning');
                return itemData;
            }
        }

        async getProducts(query = {}) {
            return await this.getItems('products', query);
        }

        async getOrders(query = {}) {
            return await this.getItems('orders', query);
        }

        async getItems(type, query = {}) {
            // Try server first if online
            if (this.isOnline) {
                try {
                    const serverData = await this.fetchFromServer(type, query);
                    this.cacheLocally(type, serverData);
                    
                    // Merge with local unsynced data
                    const localData = this.getLocalItems(type);
                    const unsynced = localData.filter(item => item._local && !item._synced);
                    
                    return [...serverData, ...unsynced];
                } catch (error) {
                    console.log(`Server fetch failed, using local:`, error);
                }
            }
            
            // Fallback to local data
            return this.getLocalItems(type, query);
        }

        // ==================== SERVER COMMUNICATION ====================
        async saveToServer(type, data) {
            const endpoint = this.endpoints[type];
            if (!endpoint) throw new Error(`No endpoint for ${type}`);
            
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: this.getHeaders(),
                body: JSON.stringify(data)
            });
            
            if (!response.ok) throw new Error(`Server error: ${response.status}`);
            
            return await response.json();
        }

        async fetchFromServer(type, query = {}) {
            const endpoint = this.endpoints[type];
            if (!endpoint) return [];
            
            let url = endpoint;
            if (Object.keys(query).length > 0) {
                const params = new URLSearchParams(query);
                url += `?${params.toString()}`;
            }
            
            const response = await fetch(url, {
                headers: this.getHeaders()
            });
            
            if (!response.ok) throw new Error(`Fetch error: ${response.status}`);
            
            return await response.json();
        }

        getHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (this.authToken) {
                headers['Authorization'] = `Bearer ${this.authToken}`;
            }
            
            return headers;
        }

        // ==================== LOCAL STORAGE ====================
        saveToLocalStorage(type, data) {
            const key = `ws_${type}`;
            let items = JSON.parse(localStorage.getItem(key) || '[]');
            
            // Remove if exists
            items = items.filter(item => item._id !== data._id);
            
            // Add new item
            items.push(data);
            
            localStorage.setItem(key, JSON.stringify(items));
            this.updateUI();
        }

        getLocalItems(type, query = {}) {
            const key = `ws_${type}`;
            let items = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (Object.keys(query).length === 0) return items;
            
            return items.filter(item => {
                return Object.entries(query).every(([key, value]) => {
                    return item[key] == value;
                });
            });
        }

        updateLocalItem(type, id, updates) {
            const key = `ws_${type}`;
            let items = JSON.parse(localStorage.getItem(key) || '[]');
            
            items = items.map(item => 
                item._id === id ? { ...item, ...updates } : item
            );
            
            localStorage.setItem(key, JSON.stringify(items));
            this.updateUI();
        }

        cacheLocally(type, dataArray) {
            const key = `ws_${type}_cache`;
            const cache = {
                data: dataArray,
                timestamp: Date.now()
            };
            localStorage.setItem(key, JSON.stringify(cache));
        }

        // ==================== SYNC QUEUE ====================
        queueForSync(type, operation, data) {
            const queueItem = {
                id: `sync_${Date.now()}`,
                type: type,
                operation: operation,
                data: data,
                attempts: 0,
                createdAt: new Date().toISOString()
            };
            
            this.syncQueue.push(queueItem);
            this.saveQueue();
            this.updateUI();
        }

        async syncQueueToServer() {
            if (!this.isOnline || this.syncQueue.length === 0) return;
            
            console.log(`ðŸ”„ Syncing ${this.syncQueue.length} items...`);
            
            for (const item of [...this.syncQueue]) {
                try {
                    if (item.operation === 'create') {
                        await this.saveToServer(item.type, item.data);
                    }
                    
                    // Mark as synced
                    if (item.data._id) {
                        this.updateLocalItem(item.type, item.data._id, {
                            _synced: true,
                            _local: false
                        });
                    }
                    
                    // Remove from queue
                    this.syncQueue = this.syncQueue.filter(q => q.id !== item.id);
                    
                } catch (error) {
                    console.log(`Sync failed:`, error);
                    item.attempts++;
                    
                    if (item.attempts >= 3) {
                        this.syncQueue = this.syncQueue.filter(q => q.id !== item.id);
                    }
                }
            }
            
            this.saveQueue();
            this.updateUI();
            
            if (this.syncQueue.length === 0) {
                this.showNotification('All data synced!', 'success');
            }
        }

        // ==================== UI COMPONENTS ====================
        addStorageUI() {
            // Add status indicator to dashboard
            const indicator = document.createElement('div');
            indicator.id = 'ws-storage-indicator';
            indicator.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 8px 15px;
                    background: #28a745;
                    color: white;
                    border-radius: 20px;
                    font-size: 13px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    z-index: 9999;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.3s;
                ">
                    <span id="ws-status-icon">âœ“</span>
                    <span id="ws-status-text">Synced</span>
                    <span id="ws-queue-count" style="
                        background: rgba(255,255,255,0.2);
                        padding: 2px 8px;
                        border-radius: 10px;
                        font-size: 11px;
                        display: none;
                    ">0</span>
                </div>
            `;
            
            document.body.appendChild(indicator);
            
            // Add notification area
            const notifications = document.createElement('div');
            notifications.id = 'ws-notifications';
            notifications.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9998;
                max-width: 300px;
            `;
            document.body.appendChild(notifications);
            
            // Update UI
            this.updateUI();
        }

        updateUI() {
            const indicator = document.getElementById('ws-storage-indicator');
            if (!indicator) return;
            
            const icon = document.getElementById('ws-status-icon');
            const text = document.getElementById('ws-status-text');
            const count = document.getElementById('ws-queue-count');
            
            if (!this.isOnline) {
                indicator.style.background = '#dc3545';
                icon.textContent = 'âš ';
                text.textContent = 'Offline';
                count.style.display = 'none';
            } else if (this.syncQueue.length > 0) {
                indicator.style.background = '#ffc107';
                icon.textContent = 'ðŸ”„';
                text.textContent = 'Syncing';
                count.textContent = this.syncQueue.length;
                count.style.display = 'inline';
            } else {
                indicator.style.background = '#28a745';
                icon.textContent = 'âœ“';
                text.textContent = 'Synced';
                count.style.display = 'none';
            }
            
            // Add click handler
            indicator.onclick = () => this.showStatusPanel();
        }

        showNotification(message, type = 'info') {
            const container = document.getElementById('ws-notifications');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                background: ${type === 'success' ? '#d4edda' : 
                           type === 'warning' ? '#fff3cd' : 
                           type === 'error' ? '#f8d7da' : '#d1ecf1'};
                color: ${type === 'success' ? '#155724' : 
                        type === 'warning' ? '#856404' : 
                        type === 'error' ? '#721c24' : '#0c5460'};
                padding: 12px 16px;
                margin-bottom: 10px;
                border-radius: 6px;
                border-left: 4px solid ${type === 'success' ? '#28a745' : 
                                     type === 'warning' ? '#ffc107' : 
                                     type === 'error' ? '#dc3545' : '#17a2b8'};
                animation: wsSlideIn 0.3s ease;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                font-size: 14px;
            `;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Auto-remove
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100px)';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 4000);
            
            // Add animation CSS
            if (!document.querySelector('#ws-animations')) {
                const style = document.createElement('style');
                style.id = 'ws-animations';
                style.textContent = `
                    @keyframes wsSlideIn {
                        from {
                            opacity: 0;
                            transform: translateX(100px);
                        }
                        to {
                            opacity: 1;
                            transform: translateX(0);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        showStatusPanel() {
            const panel = document.createElement('div');
            panel.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 25px;
                border-radius: 10px;
                box-shadow: 0 15px 35px rgba(0,0,0,0.2);
                z-index: 10000;
                min-width: 350px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                border: 1px solid #e0e0e0;
            `;
            
            panel.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: #333; font-size: 18px;">
                    ðŸ›’ Storage Status
                </h3>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666;">Status:</span>
                        <span style="color: ${this.isOnline ? '#28a745' : '#dc3545'}; font-weight: 500;">
                            ${this.isOnline ? 'Online' : 'Offline'}
                        </span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666;">Pending Sync:</span>
                        <span style="color: ${this.syncQueue.length > 0 ? '#ff9800' : '#4caf50'}; font-weight: 500;">
                            ${this.syncQueue.length} items
                        </span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666;">Local Products:</span>
                        <span>${this.getLocalItems('products').length}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                        <span style="color: #666;">Local Orders:</span>
                        <span>${this.getLocalItems('orders').length}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin: 10px 0; padding: 8px 0;">
                        <span style="color: #666;">Storage Used:</span>
                        <span>${this.getStorageUsage()}</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 25px; border-top: 1px solid #eee; padding-top: 20px;">
                    <button onclick="window.wsStorage.syncNow()" style="
                        flex: 1;
                        padding: 10px 15px;
                        background: #2196f3;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 500;
                    ">ðŸ”„ Sync Now</button>
                    
                    <button onclick="this.parentNode.parentNode.remove()" style="
                        flex: 1;
                        padding: 10px 15px;
                        background: #9e9e9e;
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 500;
                    ">Close</button>
                </div>
            `;
            
            document.body.appendChild(panel);
            
            // Close on outside click
            panel.onclick = (e) => e.stopPropagation();
            document.onclick = () => panel.remove();
        }

        // ==================== DASHBOARD INTEGRATION ====================
        integrateWithDashboard() {
            console.log('ðŸ”— Integrating with your dashboard...');
            
            // Wait for dashboard to load
            setTimeout(() => {
                this.addStorageButtons();
                this.monitorDashboardChanges();
            }, 2000);
        }

        addStorageButtons() {
            // Add storage button to Products page
            const productsHeader = document.querySelector('h1, h2, h3, [class*="header"], [class*="title"]');
            if (productsHeader && productsHeader.textContent.includes('Product')) {
                if (!document.querySelector('.ws-storage-btn')) {
                    const btn = document.createElement('button');
                    btn.className = 'ws-storage-btn';
                    btn.innerHTML = 'ðŸ’¾ Smart Save';
                    btn.style.cssText = `
                        margin-left: 15px;
                        padding: 8px 16px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 500;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                        transition: transform 0.2s;
                    `;
                    btn.onmouseenter = () => btn.style.transform = 'translateY(-2px)';
                    btn.onmouseleave = () => btn.style.transform = 'translateY(0)';
                    
                    btn.onclick = () => {
                        this.saveCurrentProduct();
                    };
                    
                    productsHeader.parentNode.insertBefore(btn, productsHeader.nextSibling);
                }
            }
            
            // Add storage info to dashboard stats
            this.addToDashboardStats();
        }

        addToDashboardStats() {
            // Find the "Store Overview" section
            const overviewSection = document.querySelector('[class*="overview"], [class*="stats"], [class*="dashboard"]');
            if (overviewSection) {
                const storageStat = document.createElement('div');
                storageStat.innerHTML = `
                    <div style="
                        background: white;
                        border-radius: 10px;
                        padding: 20px;
                        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        margin: 15px 0;
                        border-left: 4px solid #2196f3;
                    ">
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">Storage Status</div>
                        <div style="font-size: 24px; font-weight: bold; color: #333;">
                            ${this.getLocalItems('products').length} Products
                        </div>
                        <div style="font-size: 14px; color: #888; margin-top: 5px;">
                            ${this.syncQueue.length} pending sync â€¢ ${this.isOnline ? 'Online' : 'Offline'}
                        </div>
                    </div>
                `;
                
                overviewSection.appendChild(storageStat);
            }
        }

        monitorDashboardChanges() {
            // Monitor for new products/orders being added
            const observer = new MutationObserver((mutations) => {
                mutations.forEach(mutation => {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) { // Element node
                                // Check if it's a product form
                                if (node.querySelector && (
                                    node.querySelector('[name*="product"]') ||
                                    node.querySelector('[id*="product"]') ||
                                    node.querySelector('[class*="product"]')
                                )) {
                                    this.attachToProductForm(node);
                                }
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        attachToProductForm(formElement) {
            const form = formElement.querySelector('form') || formElement;
            if (form && !form.querySelector('.ws-auto-save')) {
                const checkbox = document.createElement('div');
                checkbox.innerHTML = `
                    <label style="display: flex; align-items: center; gap: 8px; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                        <input type="checkbox" class="ws-auto-save-checkbox">
                        <span style="font-size: 14px; color: #333;">ðŸ’¾ Auto-save to local storage</span>
                    </label>
                `;
                form.appendChild(checkbox);
                
                // Auto-save on form submit
                form.addEventListener('submit', (e) => {
                    if (form.querySelector('.ws-auto-save-checkbox').checked) {
                        this.saveFormData(form, 'products');
                    }
                });
            }
        }

        saveCurrentProduct() {
            // Find product form data
            const form = document.querySelector('form');
            if (form) {
                this.saveFormData(form, 'products');
            } else {
                this.showNotification('No form found to save', 'warning');
            }
        }

        saveFormData(form, type) {
            const formData = new FormData(form);
            const data = {};
            
            for (const [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            this.saveItem(type, data);
            this.showNotification(`${type} saved with smart storage!`, 'success');
        }

        // ==================== UTILITY METHODS ====================
        handleOnline() {
            this.isOnline = true;
            console.log('ðŸŒ Online - starting sync');
            this.showNotification('Back online. Syncing data...', 'success');
            this.syncQueueToServer();
        }

        handleOffline() {
            this.isOnline = false;
            console.log('ðŸ“´ Offline - using local storage');
            this.showNotification('You are offline. Data saved locally.', 'warning');
        }

        saveQueue() {
            localStorage.setItem('ws_sync_queue', JSON.stringify(this.syncQueue));
        }

        loadQueue() {
            const saved = localStorage.getItem('ws_sync_queue');
            this.syncQueue = saved ? JSON.parse(saved) : [];
        }

        getStorageUsage() {
            let total = 0;
            for (let key in localStorage) {
                if (key.startsWith('ws_')) {
                    total += localStorage[key].length * 2;
                }
            }
            return (total / 1024).toFixed(2) + ' KB';
        }

        syncNow() {
            this.showNotification('Manual sync started...', 'info');
            this.syncQueueToServer();
        }

        // ==================== PUBLIC API ====================
        getAPI() {
            return {
                // Save methods
                saveProduct: (data) => this.saveProduct(data),
                saveOrder: (data) => this.saveOrder(data),
                saveCustomer: (data) => this.saveCustomer(data),
                saveItem: (type, data) => this.saveItem(type, data),
                
                // Get methods
                getProducts: (query) => this.getProducts(query),
                getOrders: (query) => this.getOrders(query),
                getItems: (type, query) => this.getItems(type, query),
                
                // Status
                status: () => ({
                    online: this.isOnline,
                    queue: this.syncQueue.length,
                    localProducts: this.getLocalItems('products').length,
                    localOrders: this.getLocalItems('orders').length
                }),
                
                // Actions
                syncNow: () => this.syncNow(),
                showPanel: () => this.showStatusPanel(),
                clearLocal: () => {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('ws_')) {
                            localStorage.removeItem(key);
                        }
                    });
                    this.showNotification('Local storage cleared', 'info');
                    this.updateUI();
                }
            };
        }
    }

    // ==================== GLOBAL SETUP ====================
    
    // Initialize when page loads
    window.addEventListener('load', () => {
        console.log('ðŸ“Š Initializing Wholesale Storage for Dashboard...');
        
        // Create storage instance
        window.wsStorage = new WholesaleStorage();
        
        // Make simplified API available
        window.$ws = window.wsStorage.getAPI();
        
        // Add test function
        window.testWholesaleStorage = async () => {
            console.log('ðŸ§ª Testing wholesale storage...');
            
            // Test product save
            const testProduct = {
                name: "Test Product " + new Date().getTime(),
                price: Math.floor(Math.random() * 1000) + 100,
                stock: Math.floor(Math.random() * 100) + 1,
                category: "Test Category",
                sku: "TEST-" + Date.now()
            };
            
            const saved = await window.$ws.saveProduct(testProduct);
            console.log('Product saved:', saved);
            
            // Test getting products
            const products = await window.$ws.getProducts();
            console.log('Total products:', products.length);
            
            // Show status
            const status = window.$ws.status();
            console.log('Storage status:', status);
            
            alert(`âœ… Wholesale Storage Test Complete!\nSaved: ${testProduct.name}\nLocal Products: ${products.length}\nOnline: ${status.online}`);
        };
        
        // Add test button to dashboard
        setTimeout(() => {
            if (!document.querySelector('#ws-test-btn')) {
                const testBtn = document.createElement('button');
                testBtn.id = 'ws-test-btn';
                testBtn.textContent = 'Test Storage';
                testBtn.style.cssText = `
                    position: fixed;
                    bottom: 70px;
                    right: 20px;
                    padding: 10px 16px;
                    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                    color: white;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    z-index: 9999;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-size: 14px;
                    font-weight: 500;
                    box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
                    transition: transform 0.2s;
                `;
                testBtn.onmouseenter = () => testBtn.style.transform = 'translateY(-2px)';
                testBtn.onmouseleave = () => testBtn.style.transform = 'translateY(0)';
                testBtn.onclick = window.testWholesaleStorage;
                document.body.appendChild(testBtn);
            }
        }, 1500);
        
        console.log('ðŸŽ‰ Wholesale Storage System Ready!');
        console.log('Available: window.wsStorage (full) or window.$ws (simple)');
    });

})();
